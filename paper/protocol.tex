\section{\CROCUS:\@ A protocol for crowd counting estimation}%
\label{Protocol}


We now present \CROCUS, a protocol for privately verifyiable crowd counts.
The protocol consists of five phases: setup (in \cref{ProtocolSetup}),
join, participation, submission (all in in \cref{ProtocolDuring} ) and
verification (in \cref{ProtocolVerification}).

Several entities are involved in our protocol.
First, \iac{CA} is responsible for certifying a one-to-one mapping between a 
person's identity and a cryptographic key\footnote{%
  This can be done by a centralized authority, such as a nation state with, 
  \eg, passports; or a decentralized authority, as in the case of a a 
  collective authority~\cite{collective-signing} powered by 
  proof-of-personhood~\cite{proof-of-personhood}.
}.
The \ac{CA} is only involved in the setup phase.
Second, a participant is an individual who wants to participate in a given 
protest.
A participant can assume three different roles:
\begin{enumerate}
\item The \emph{organizer} has written a manifesto for the protest and forward it to others.
\item A \emph{protester} is attending the protest and asks witnesses to vouch 
  for his presence.
\item A \emph{witness} provides proofs to protesters which state that the 
  protester was indeed participating and such that the proofs are verifiable by 
  third parties.
\end{enumerate}
In general, there is one organizer and every participant can act alternatively 
as both protester and witness.

\subsection{Setup phase}%
\label{ProtocolSetup}

The setup phase is only run once and is the same as in Anon-Pass~\cite{AnonPass}.
More precisely, we have simply adapted their description to our notation, but otherwise we have the setting as similar as possible.


\emph{Setup: \((\spk, \ssk)\gets \CROCUSsetup\).}
During the setup phase, the \ac{CA} creates all the needed keys.
The \ac{CA} generates a service public-private key-pair \((\spk, \ssk)\gets 
  \ACsetup\) (see \cref{CLsignAlg}).

\emph{Registration: \(\sk\gets 
    \Proto{\CROCUSreg[_P][\spk]}{\CROCUSreg[_{\CA}][\ssk]}\).}
During the registration phase, each participant generates a secret key and 
obtains a signature on it by the \ac{CA} but without revealing it to the 
\ac{CA}.
At the end, each participant will have a signed secret key while the \ac{CA} 
will issue only one signature per participant but without knowing the 
association between a particular key and the identity of the participant.
The participant chooses \(k, r\rgets \ZZ_q\) uniformly randomly and runs 
\(\sigma \gets \Proto{\ACgetSig[\spk, k, r]}{\ACissueSig[\spk, \ssk]}\) (see 
\cref{CLacSigAlg}).
Upon success, the participant sets \(\sk = (\sigma, k, r)\).

The setup and registration phases can be done once and the keys can be reused 
for an arbitrary number of protests.
Thus, the registration phase could be easily integrated as part of the issuance 
of national identity cards, passports or \acp{eID}.

\subsection{Creation, join and participation in a protest and submission of proofs}%
\label{ProtocolDuring}

The join, participation and submission phases are illustrated in \cref{fig:ProtocolOverview}.
The participation proof share that will be constructed in the participation phase is illustrated in \cref{fig:ProofFig}.

\emph{Creation of a protest: the manifesto.}
The organizer will write a manifesto for the protest, which describes its cause.
This manifesto could take the form of any intelligible text.
The organizer will then distribute this manifesto to people through any means he wants (\eg on the Web, on placards, \etc).
If they agree on the cause, they will use the knowledge of the manifesto to join the protest.


\emph{Joining as a protester: \((\pid, t_s)\gets 
    \CROCUSjoin[_P][\text{manifesto}]\).}
A protester who wants to join the protest will use the manifesto to compute an identifier for the cause by hashing the manifesto, \(\cid\gets \Hash[\mfst]\).
Afterwards, this identifier is used to create the protest-specific identifier 
for the protester, \(\pid\gets \ACprf[_{\sk_P}][\cid]\) (see 
\cref{fig:ProofFig,fig:ProtocolOverview} and \cref{ACprfAlg}).
The protester should also receive a time-correlated random value from the 
time-stamping service, \(t_s\gets \TSget\).


\begin{figure}
  \centering
  \small
  \includegraphics{proofshare.tikz}
  \caption{%
    Structure of a proof share.
    The protest (cause) identifier \(\cid\) is the hash value of the manifesto.
    The protester \(P\)'s identifier \(\pid\) is computed using the protester's key \(\sk_P\) and \(\cid\).
    The witness \(W\)'s protester-specific identifier \(\wid\) is computed using the
    witness's key \(\sk_W\) and the protester's \(\pid\).
    \(t_s, t_s'\) are the hashes of the head blocks in the ledger seen by the 
    protester and witness, respectively, and \(l\) is an area.
    All values are signed by the witness (signature \(\prf_W = \SPK[\sk_W][\wid 
      = \dotsb][\cid, \pid, \wid, t_s, t_s', l]\)) while also proving the 
    correctness of \(\wid\) and knowledge of a signature on \(\sk_W\).
    The protester constructs \(\prf_P\) analogously.
  }%
  \label{fig:ProofFig}
\end{figure}%

\begin{figure}
  \centering
  \small
  \begin{minipage}{\linewidth}
    \begin{align*}
      O\to \text{all}\colon & \text{manifesto} \\
      P\colon & t_s\gets \TSget \\
        & \cid\gets \Hash[\text{manifesto}], \\
        & \pid\gets \ACprf[_{\sk_P}][\cid] \\
      W\colon & t_s'\gets \TSget
      \\[-1em]
      \noalign{\hfill Join}
      \midrule
      \noalign{\hfill Participation}
      \\[-3em]
      P\to W\colon & \pid \\
      P\leftrightarrow W\colon &
        \PPK\mleft\{ (\sk_P) : \mright. \\
        & \qquad \pid = \ACprf[_{\sk_P}][\cid], \\
        & \qquad \mleft. \sigma_P' = \ACblind[\ACsign[_{\ssk}][\sk_P]] \mright\} 
        \\
      W\colon & \wid\gets \ACprf[_{\sk_W}][\pid] \\
      W\to P\colon & (\wid, t_s', l)
      \\[-1em]
      \noalign{\hfill Participation}
      \midrule
      \noalign{\hfill Submission}
      \\[-2em]
      P\colon & t_e\gets \TSstamp[\Hash[\pid, \wid, t_s, t_s', l]] \\
      W\colon & t_e'\gets \TSstamp[\Hash[\pid, \wid, t_s, t_s', l]] \\
      W\to S\colon & (\cid, \pid, \wid, t_s, t_s', t_e, l, \pi_{\wid}),\quad 
      \text{where} \\
        & \pi_{\wid} = \SPK\mleft\{ (\sk_W) : \mright. \\
        & \qquad \wid = \ACprf[_{\sk_W}][\pid], \\
        & \qquad \mleft. \sigma_W' = \ACblind[\ACsign[_{\ssk}][\sk_W]]\mright\} 
        \\
        & \qquad\qquad (\cid, \pid, \wid, t_s, t_s', l) \\
      P\to S\colon & (\cid, \pid, \wid, t_s, t_s', t_e, l, \pi_{\pid}),\quad 
      \text{where}\\
        & \pi_{\pid} = \SPK\mleft\{ (\sk_P) : \mright. \\
        & \qquad \pid = \ACprf[_{\sk_P}][\cid], \\
        & \qquad \mleft. \sigma_P' = \ACblind[\ACsign[_{\ssk}][\sk_P]] \mright\} 
        \\
        & \qquad\qquad (\cid, \pid, \wid, t_s, t_s', l)
    \end{align*}
  \end{minipage}
  \caption{%
    An overview of the Join, Participation and Submission phases of \CROCUS.\@
    The organizer \(O\) broadcasts the manifesto.
    The protester \(P\), witness \(W\) and their computations are as in \cref{fig:ProofFig}.
    Finally, both \(P\) and \(W\) submit the proof shares to a
    permanent storage \(S\). Note that \pid always refers to the
    protester whose presence is being witnessed.
  }%
  \label{fig:ProtocolOverview}
\end{figure}

\emph{Joining as a witness: \(t_s'\gets \CROCUSjoin_W\).}
The witness should simply get a time-correlated random value from the time-stamping service, \(t_s'\gets \TSget\).
Note that we do this for redundancy, the newest of \(t_s\) and \(t_s'\) will 
set the start of the time interval of creation for the proof share.


\emph{Participation: \(\pi\gets
    \Proto{\CROCUSparticipate[\cid, \sk_P]}{\CROCUSwitness[\sk_W, \spk]}\),}
In the participation phase (see \cref{fig:ProtocolOverview}), the protester and 
the witness construct the proof share of the protester (\cref{fig:ProofFig}).

The protester sends \(\pid\) to the witness.
Then they run the protocol \(\Proto{\ACproveSig[\spk, k, r, 
    \sigma]}{\ACverifySig[\spk, \ssk]}\) (see \cref{ACacAlg}).
Note that the \ac{PK} in \cref{ACacAlg} must be run as \iac{PPK}.
If the protocol succeeds, the witness will compute \(\wid \gets 
  \ACprf[_{\sk_W}][\pid]\) and send \((\wid, t_s', l)\) to the protester.


\emph{Submission: \(\psh_P\gets \CROCUSsubmit[_P][\cid, \pid, \wid, t_s, t_s',  l]\).}
The participant should as soon as possible commit the proof-share data to the 
time-stamping service and receive the proof of commitment, \(t_e\gets 
  \TSstamp[\Hash[\cid, \pid, \wid, t_s, t_s', l]]\).
The remaining operations are not time critical.
The protester computes \iac{NIZK} proof \(\pi_{\pid}\), which shows the 
correctness of \(\pid\).
More specifically,
\begin{multline*}
  \pi_{\pid}\gets \SPK\left\{ (\sk_P) : \right. \\
    \begin{aligned}
      \pid &= \ACprf[_{\sk_P}][\cid] \quad \land \\
      \sigma_P' &= \left. \ACblind[\ACsign[_{\ssk}][\sk_P]] \right\}
    \end{aligned} \\
      (\cid, \pid, \wid, t_s, t_s', l).
\end{multline*}
Finally, the protester uploads the tuple \[  \psh_P = (\cid, \pid, \wid, t_s, t_s', t_e, l, \pi_{\pid})\] for permanent storage.

\emph{Submission: \(\psh_W\gets \CROCUSsubmit[_W][\cid, \pid, \wid, t_s, t_s', 
    l]\).}
The witness should, just as the participant, commit the proof-share data to the 
time-stamping service, \(t_e'\gets \TSstamp[\Hash[\cid, \pid, \wid, t_s, t_s', 
  l]]\).
(This is to make the time interval as early as possible, whoever is the faster 
will submit it.)
Then, without any time requirements, the witness computes \iac{NIZK} proof 
\(\pi_{\wid}\) as follows:
\begin{multline*}
  \pi_{\wid}\gets \SPK\left\{ (\sk_W) : \right. \\
    \begin{aligned}
      \wid &= \ACprf[_{\sk_W}][\pid] \quad \land \\
      \sigma_W' &= \left. \ACblind[\ACsign[_{\ssk}][\sk_W]] \right\}
    \end{aligned} \\
      (\cid, \pid, \wid, t_s, t_s', l).
\end{multline*}
Finally, the witness uploads the tuple \[ \psh_W = (\cid, \pid, \wid, t_s, 
  t_s', t_e', l, \pi_{\wid}) \] for permanent storage.

\subsection{Verifying the participation count}%
\label{ProtocolVerification}

While there are various ways for verifying the participation count, hereafter, 
we will detail the two suggested just after \cref{DefParticipationCount}.
In the first approach, we do not trust individual witnesses, rather we \emph{assume} that it is difficult for Alice to find more than \(\theta\) witnesses willing to collude.
Thus, the strength comes from the number of witnesses and we require at least \(\theta\) witnesses to accept a participation proof as valid.
In the second approach, we trust specific witnesses, but no others.
In this case, to accept a participation proof as valid, we require at least one trusted witness, the independent journalist Jane.
It is the strength function \(\str\) of \cref{DefParticipationCount} that 
differ in the two cases.
We will first give the procedure and then how to construct the two different 
strength functions.

To verify the participation count for a subprotest \(\sprtst = (\cid, t, l)\) 
(see \cref{DefProtest}), a verifier must download all the proof shares \[
  \psh_i =   (\cid, \pid_j, \wid_i, t_s^{(i)}, t_s^{\prime (i)}, t_e^{(i)}, 
  t_e^{\prime   (i)}, l_i, \prf_{\pid_j}^{(i)}, \prf_{\wid_i})
\] for each protester \(j\) from the ledger, verify \(\prf_{\pid_j}^{(i)}\), 
\(\prf_{\wid_i}\) and that the interval \(\interval{\max(t_s^{(i)}, t_s^{\prime 
      (i)})}{\min(t_e^{(i)}, t_e^{\prime (i)})}\subseteq t\) and that 
\(l_i\subseteq  l\).
Any proof share that does not verify correctly will be discarded.
At this point, the verifier has constructed the set \(S\) from 
\cref{DefProofShares} and can thus construct any participation proof 
\(\prf_{\pid_j, P}\) as in \cref{DefParticipationProof}.
Now the verifier can compute the participation count \(|\prfs_P^{\str, 
    \theta}|\) as in \cref{DefParticipationCount}.

In the case \emph{without} trusted witnesses, all the weights equal to 1 is equivalent to counting the elements in the set, 
\(\str[\prf_{\pid_j, P}] = |\prf_{\pid_j, P}|\).

In the case \emph{with} trusted witnesses, each trusted witness must inform the 
verifier of which proof shares that he or she has signed, \eg by giving a list 
of all such proof shares or digitally sign each proof share\footnote{%
  To achieve witness privacy in this situation, one could employ a group or 
  ring signature scheme for all trusted witnesses.
  Then one learns that at least one trusted witness must have been there.
}.
Then the verifier can define \[
  \str[\prf_{\pid_j, P}] = \begin{cases}
    1 & \text{if \(\exists \psh_i\in \prf_{\pid_j, P}\) that is such a proof 
      share} \\
    0 & \text{otherwise}
  \end{cases}
\] and sets \(\theta = 1\).
